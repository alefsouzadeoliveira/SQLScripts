-- Subquery e join, criando tabela analitica a partir de um modelo oltp


SELECT * FROM (
    SELECT 
        DB_CLIENTE.NM_CLIENTE ,
        DB_ESTADO.NM_ESTADO AS  NOME_ESTADO,
        SUM(DB_ITEM_PEDIDO.NR_PEDIDO) AS QTDE_PEDIDO,
        SUM(DB_ITEM_PEDIDO.QT_PEDIDO * DB_ITEM_PEDIDO.VL_UNITARIO) AS valor_bruto_venda
    FROM 
        DB_ITEM_PEDIDO 
    INNER JOIN 
        DB_PEDIDO ON DB_ITEM_PEDIDO.NR_PEDIDO = DB_PEDIDO.NR_PEDIDO
    INNER JOIN 
         DB_LOJA ON  DB_LOJA.NR_LOJA =  DB_PEDIDO.NR_LOJA
    INNER JOIN
        DB_END_LOJA ON DB_END_LOJA.NR_LOJA = DB_LOJA.NR_LOJA 
    INNER JOIN 
        DB_LOGRADOURO ON  DB_LOGRADOURO.CD_LOGRADOURO = DB_END_LOJA.CD_LOGRADOURO
    INNER JOIN 
        DB_BAIRRO ON DB_BAIRRO.CD_BAIRRO = DB_LOGRADOURO.CD_BAIRRO
    INNER JOIN 
        DB_CIDADE ON  DB_CIDADE.CD_CIDADE = DB_BAIRRO.CD_CIDADE
    INNER JOIN 
        DB_ESTADO ON DB_ESTADO.SG_ESTADO = DB_CIDADE.SG_ESTADO
    INNER JOIN  
        DB_ITEM_PEDIDO ON DB_ITEM_PEDIDO.NR_PEDIDO = DB_PEDIDO.NR_PEDIDO 
    INNER JOIN 
        DB_END_CLI ON DB_END_CLI.NR_CLIENTE = DB_PEDIDO.NR_CLIENTE 
    INNER JOIN
        DB_CLIENTE ON  DB_CLIENTE.NR_CLIENTE = DB_END_CLI.NR_CLIENTE
    WHERE DB_ESTADO.NM_ESTADO = 'SAO PAULO'
    GROUP BY 
        DB_ESTADO.NM_ESTADO,
        NM_CLIENTE 
    ORDER BY
        valor_bruto_venda DESC
)
WHERE ROWNUM <= 5;